// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["interactiveTransactions"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// TODO: User accounts mapped from Clerk
/// TODO: User permissions/grants

model Team {
  id                           Int                           @id @default(autoincrement())
  uid                          String                        @unique @default(cuid())
  name                         String                        @unique
  logo                         Image?                        @relation(fields: [logoUid], references: [uid])
  logoUid                      String?
  blog                         String?
  officeHours                  String?
  website                      String?
  contactMethod                String?
  twitterHandler               String?
  linkedinHandler              String?
  telegramHandler              String?
  shortDescription             String?
  longDescription              String?
  tier                         Int?                          @default(-1)
  plnFriend                    Boolean                       @default(false)
  isFeatured                   Boolean?                      @default(false)
  isFund                       Boolean                       @default(false)
  airtableRecId                String?                       @unique
  createdAt                    DateTime                      @default(now())
  updatedAt                    DateTime                      @updatedAt
  lastModifiedBy               String?
  lastModifier                 Member?                       @relation("LastModification", fields: [lastModifiedBy], references: [uid])
  teamMemberRoles              TeamMemberRole[]
  industryTags                 IndustryTag[]
  membershipSources            MembershipSource[]
  fundingStage                 FundingStage?                 @relation(fields: [fundingStageUid], references: [uid])
  fundingStageUid              String?
  technologies                 Technology[]
  moreDetails                  String?
  maintainingProjects          Project[]                     @relation("maintainingTeam")
  contributingProjects         Project[]                     @relation("contributingTeams")
  eventGuests                  PLEventGuest[]
  teamFocusAreas               TeamFocusArea[]
  teamFocusAreasVersionHistory TeamFocusAreaVersionHistory[]
  relatedQuestions             DiscoveryQuestion[]           @relation("TeamRelatedDiscoveryQuestions")
  asks                         Ask[]
  fundraisingProfiles          TeamFundraisingProfile[]
  investorProfile              InvestorProfile?              @relation("TeamInvestorProfile", fields: [investorProfileId], references: [uid])
  investorProfileId            String?                       @unique
  demoDayParticipants          DemoDayParticipant[]
  accessLevel                  String?                       @default("L1")
  accessLevelUpdatedAt         DateTime                      @default(now())
}

enum AskStatus {
  OPEN
  CLOSED
}

model Ask {
  id            Int       @id @default(autoincrement())
  uid           String    @unique @default(cuid())
  title         String
  description   String
  tags          String[]
  team          Team?     @relation(fields: [teamUid], references: [uid])
  teamUid       String?
  project       Project?  @relation(fields: [projectUid], references: [uid])
  projectUid    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  status        AskStatus @default(OPEN)
  closedAt      DateTime?
  closedReason  String?
  closedComment String?
  closedBy      Member?   @relation(fields: [closedByUid], references: [uid])
  closedByUid   String?
}

model Member {
  id                               Int                               @id @default(autoincrement())
  uid                              String                            @unique @default(cuid())
  name                             String
  email                            String?                           @unique
  image                            Image?                            @relation(fields: [imageUid], references: [uid])
  imageUid                         String?
  githubHandler                    String?
  discordHandler                   String?
  twitterHandler                   String?
  linkedinHandler                  String?
  telegramHandler                  String?                           @unique
  telegramUid                      String?                           @unique
  officeHours                      String?
  ohStatus                         String?
  ohInterest                       String[]                          @default([])
  ohHelpWith                       String[]                          @default([])
  moreDetails                      String?
  bio                              String?
  plnFriend                        Boolean?                          @default(false)
  plnStartDate                     DateTime?
  airtableRecId                    String?                           @unique
  externalId                       String?                           @unique
  openToWork                       Boolean?                          @default(false)
  isFeatured                       Boolean?                          @default(false)
  isTierViewer                     Boolean?                          @default(false)
  isVerified                       Boolean?                          @default(false)
  signUpSource                     String?
  signUpMedium                     String?
  signUpCampaign                   String?
  isUserConsent                    Boolean?                          @default(false)
  isSubscribedToNewsletter         Boolean?                          @default(false)
  teamOrProjectURL                 String?
  createdAt                        DateTime                          @default(now())
  updatedAt                        DateTime                          @updatedAt
  approvedAt                       DateTime                          @default(now())
  skills                           Skill[]
  location                         Location?                         @relation(fields: [locationUid], references: [uid])
  locationUid                      String?
  teamMemberRoles                  TeamMemberRole[]
  memberRoles                      MemberRole[]
  preferences                      Json?
  projectContributions             ProjectContribution[]
  createdProjects                  Project[]
  eventGuests                      PLEventGuest[]
  teamFocusAreasVersionHistory     TeamFocusAreaVersionHistory[]
  modifiedTeams                    Team[]                            @relation("LastModification")
  interactions                     MemberInteraction[]               @relation("SourceMemberInteractions")
  targetInteractions               MemberInteraction[]               @relation("TargetMemberInteractions")
  followUps                        MemberFollowUp[]
  feedbacks                        MemberFeedback[]
  createdQuestions                 DiscoveryQuestion[]               @relation("MemberCreatedDiscoveryQuestions")
  modifiedQuestions                DiscoveryQuestion[]               @relation("MemberModifiedDiscoveryQuestions")
  subscriptions                    MemberSubscription[]
  closedAsks                       Ask[]
  experiences                      MemberExperience[]
  linkedInDetails                  Json?
  recommendationRunsAsTarget       RecommendationRun[]
  recommendationsAsRecommended     Recommendation[]
  recommendationNotifications      RecommendationNotification[]
  notificationSetting              NotificationSetting?
  linkedinProfile                  LinkedInProfile?
  accessLevel                      String?
  role                             String?
  isInvestor                       Boolean?
  scheduleMeetingCount             Int                               @default(0)
  createdAdjustments               MemberInteractionAdjustment[]     @relation("AdjustmentCreatedBy")
  accessLevelUpdatedAt             DateTime                          @default(now())
  deletedAt                        DateTime? // soft delete timestamp
  deletionReason                   String? // reason for deletion
  aboutYou                         String? // "Tell us a bit about you" field from sign up flow
  modifiedFundraisingProfiles      TeamFundraisingProfile[]          @relation("TfpLastModifiedBy")
  uploads                          Upload[]                          @relation("MemberUploads")
  investorProfile                  InvestorProfile?                  @relation("MemberInvestorProfile", fields: [investorProfileId], references: [uid])
  investorProfileId                String?                           @unique
  demoDayParticipants              DemoDayParticipant[]
  demoDayEngagements               DemoDayEngagement[]
  demoDayExpressInterestStatistics DemoDayExpressInterestStatistic[]
  demoDayFeedbacks                 DemoDayFeedback[]
  reviewedEvents                   PLEvent[]                         @relation("PLEventReviewer")
  demoDayAdminScopes               MemberDemoDayAdminScope[]
  pushNotifications                PushNotification[]                @relation("PushNotificationRecipient")
  pushNotificationReadStatuses     PushNotificationReadStatus[]      @relation("PushNotificationReadStatuses")
}

model MemberRole {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  members   Member[]
}

enum ParticipantType {
  MEMBER
  TEAM
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  AUTOAPPROVED
}

enum PLEventType {
  INVITE_ONLY
  VIRTUAL
  IN_PERSON
}

enum MemberFollowUpStatus {
  PENDING
  COMPLETED
  CLOSED
}

enum MemberFeedbackResponseType {
  POSITIVE
  NEGATIVE
  NEUTRAL
}

enum ImageSize {
  ORIGINAL
  LARGE
  MEDIUM
  SMALL
  TINY
}

enum DiscoveryQuestionType {
  CHAT
  FOLLOW_UP
}

enum PLEventLocationStatus {
  AUTO_MAPPED
  MANUALLY_MAPPED
}

enum AssociationRole {
  HOST
  CO_HOST
  SPEAKER
  SPONSOR
  ATTENDEE
}

enum AssociationEntityType {
  MEMBER
  TEAM
}

/// External event providers for guest sync
enum ExternalEventProvider {
  LUMA
}

model ParticipantsRequest {
  id               Int             @id @default(autoincrement())
  uid              String          @unique @default(cuid())
  participantType  ParticipantType
  status           ApprovalStatus  @default(PENDING)
  oldData          Json?
  newData          Json
  referenceUid     String?
  requesterEmailId String
  uniqueIdentifier String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
}

model Skill {
  id          Int      @id @default(autoincrement())
  uid         String   @unique @default(cuid())
  title       String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  members     Member[]
}

model Location {
  id                 Int      @id @default(autoincrement())
  uid                String   @unique @default(cuid())
  // On the location-transfer.service.ts we are adding the metroArea to the placeId to avoid duplicates because
  // since the metroArea is not valid on the Google Places API we need to append this field to avoid rewriting the same location
  placeId            String   @unique
  city               String?
  country            String
  continent          String
  region             String?
  regionAbbreviation String?
  metroArea          String?
  latitude           Float
  longitude          Float
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  members            Member[]

  @@unique([continent, country, region, city, metroArea, latitude, longitude])
}

model TeamMemberRole {
  id             Int       @id @default(autoincrement())
  mainTeam       Boolean   @default(false)
  teamLead       Boolean   @default(false)
  investmentTeam Boolean   @default(false)
  startDate      DateTime?
  endDate        DateTime?
  role           String?
  member         Member    @relation(fields: [memberUid], references: [uid], onDelete: Cascade)
  memberUid      String
  team           Team      @relation(fields: [teamUid], references: [uid], onDelete: Cascade)
  teamUid        String
  roleTags       String[]

  // One member can only have one role per team
  @@unique([memberUid, teamUid])
}

model IndustryCategory {
  id           Int           @id @default(autoincrement())
  uid          String        @unique @default(cuid())
  title        String        @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  industryTags IndustryTag[]
}

model IndustryTag {
  id                  Int               @id @default(autoincrement())
  uid                 String            @unique @default(cuid())
  title               String            @unique
  definition          String?
  airtableRecId       String?           @unique
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  industryCategory    IndustryCategory? @relation(fields: [industryCategoryUid], references: [uid])
  industryCategoryUid String?
  teams               Team[]
}

model FundingStage {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teams     Team[]
}

model MembershipSource {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teams     Team[]
}

model Technology {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teams     Team[]
}

model Image {
  id             Int       @id @default(autoincrement())
  uid            String    @unique @default(cuid())
  // The cid is not unique because this id represents an array of multiple images
  // with different sizes that can be accessed trough the cid and filename
  cid            String
  width          Int
  height         Int
  url            String
  filename       String
  size           Int
  type           String
  version        ImageSize
  // This image can be a thumbnail to other image
  thumbnailToUid String?
  thumbnailTo    Image?    @relation("ImageThumbnails", fields: [thumbnailToUid], references: [uid])
  // This image can have multiple thumbnails
  thumbnails     Image[]   @relation("ImageThumbnails")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  // Reverse Relations:
  Team           Team[]
  Member         Member[]
  Project        Project[]
  eventLogo      PLEvent[] @relation("logo")
  eventBanner    PLEvent[] @relation("banner")
}

model Faq {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  email     String   @db.VarChar(100)
  question  String
  type      String
  requestIp String   @db.VarChar(35)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model JoinRequest {
  id           Int      @id @default(autoincrement())
  uid          String   @unique @default(cuid())
  email        String   @db.VarChar(100)
  introduction String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ProjectContribution {
  id             Int       @id @default(autoincrement())
  uid            String    @unique @default(cuid())
  role           String?
  description    String?
  currentProject Boolean?  @default(false)
  startDate      DateTime?
  endDate        DateTime?
  memberUid      String
  member         Member?   @relation(fields: [memberUid], references: [uid])
  projectUid     String
  project        Project?  @relation(fields: [projectUid], references: [uid])
}

model Project {
  id                 Int                   @id @default(autoincrement())
  uid                String                @unique @default(cuid())
  logo               Image?                @relation(fields: [logoUid], references: [uid])
  logoUid            String?
  name               String
  tagline            String
  description        String
  contactEmail       String?
  lookingForFunding  Boolean               @default(false)
  projectLinks       Json?
  kpis               Json?
  readMe             String?
  score              Int?
  creator            Member?               @relation(fields: [createdBy], references: [uid])
  createdBy          String
  maintainingTeam    Team?                 @relation("maintainingTeam", fields: [maintainingTeamUid], references: [uid])
  maintainingTeamUid String
  contributingTeams  Team[]                @relation("contributingTeams")
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  isDeleted          Boolean               @default(false)
  isFeatured         Boolean?              @default(false)
  osoProjectName     String?
  projectFocusAreas  ProjectFocusArea[]
  contributions      ProjectContribution[]
  relatedQuestions   DiscoveryQuestion[]   @relation("ProjectRelatedDiscoveryQuestions")
  asks               Ask[]
  tags               String[]
}

model PLEventLocation {
  id                   Int                          @id @default(autoincrement())
  uid                  String                       @unique @default(cuid())
  location             String
  description          String?
  country              String?
  timezone             String?
  latitude             String?
  longitude            String?
  flag                 String?
  icon                 String?
  resources            Json[]
  additionalInfo       Json?
  priority             Int?
  events               PLEvent[]
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt
  isFeatured           Boolean?                     @default(false)
  isAggregated         Boolean                      @default(false)
  isDeleted            Boolean                      @default(false)
  aggregatedPriority   Int?
  locationAssociations PLEventLocationAssociation[]
  guests               PLEventGuest[]
}

model PLEventLocationAssociation {
  id            Int             @id @default(autoincrement())
  uid           String          @unique @default(cuid())
  locationUid   String
  location      PLEventLocation @relation(fields: [locationUid], references: [uid], onDelete: Cascade)
  googlePlaceId String
  locationName  String
  city          String?
  state         String?
  country       String?
  region        String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  isDeleted     Boolean         @default(false)
  PLEvent       PLEvent[]
}

model PLEvent {
  id                            Int                         @id @default(autoincrement())
  uid                           String                      @unique @default(cuid())
  type                          PLEventType?
  eventsCount                   Int?
  telegramId                    String?
  logoUid                       String?
  logo                          Image?                      @relation("logo", fields: [logoUid], references: [uid])
  bannerUid                     String?
  banner                        Image?                      @relation("banner", fields: [bannerUid], references: [uid])
  name                          String
  description                   String?
  shortDescription              String?
  websiteURL                    String?
  externalId                    String?
  isFeatured                    Boolean?                    @default(false)
  isAggregated                  Boolean                     @default(false)
  slugURL                       String                      @unique
  resources                     Json[]
  priority                      Int?
  additionalInfo                Json?
  startDate                     DateTime
  endDate                       DateTime
  isDeleted                     Boolean                     @default(false)
  createdAt                     DateTime                    @default(now())
  updatedAt                     DateTime                    @updatedAt
  syncedAt                      DateTime?
  relatedQuestions              DiscoveryQuestion[]         @relation("PLEventRelatedDiscoveryQuestions")
  locationUid                   String?
  location                      PLEventLocation?            @relation(fields: [locationUid], references: [uid])
  locationStatus                PLEventLocationStatus?
  eventGuests                   PLEventGuest[]
  reviewer                      Member?                     @relation("PLEventReviewer", fields: [reviewerUid], references: [uid])
  reviewerUid                   String?
  aggregatedPriority            Int?
  pLEventLocationAssociationUid String?
  pLEventLocationAssociation    PLEventLocationAssociation? @relation(fields: [pLEventLocationAssociationUid], references: [uid])
  eventAssociations             PLEventAssociation[]

  // External Event Integration
  externalEventProvider  ExternalEventProvider?
  externalEventId   String?
  guestLastSyncedAt      DateTime?

  @@index([externalEventProvider, externalEventId])
}

model PLEventGuest {
  id          Int      @id @default(autoincrement())
  uid         String   @unique @default(cuid())
  telegramId  String?
  officeHours String?
  reason      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  memberUid   String
  member      Member   @relation(fields: [memberUid], references: [uid], onDelete: Cascade)
  teamUid     String?
  team        Team?    @relation(fields: [teamUid], references: [uid], onDelete: Cascade)

  // Guest can be attached either to a specific event (eventUid) or to the gathering overall (eventUid = null).
  // In both cases we store locationUid to allow location-level attendees.
  locationUid String
  location    PLEventLocation @relation(fields: [locationUid], references: [uid], onDelete: Cascade)

  eventUid String?
  event    PLEvent? @relation(fields: [eventUid], references: [uid], onDelete: Cascade)

  // External guest provider ID (e.g., LUMA guest ID)
  externalGuestId String?

  additionalInfo Json?
  topics         String[]
  priority       Int?
  isHost         Boolean  @default(false)
  isSpeaker      Boolean  @default(false)
  isSponsor      Boolean  @default(false)
  isFeatured     Boolean  @default(false)

  @@index([externalGuestId])
}

model FocusArea {
  id                          Int                           @id @default(autoincrement())
  uid                         String                        @unique @default(cuid())
  title                       String                        @unique
  description                 String?
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  parentUid                   String?
  parent                      FocusArea?                    @relation("parentAreas", fields: [parentUid], references: [uid])
  children                    FocusArea[]                   @relation("parentAreas")
  teamFocusAreas              TeamFocusArea[]               @relation("teamFocusAreas")
  teamAncestorFocusAreas      TeamFocusArea[]               @relation("teamAncestorFocusAreas")
  projectFocusAreas           ProjectFocusArea[]            @relation("projectFocusAreas")
  projectAncestorFocusAreas   ProjectFocusArea[]            @relation("projectAncestorFocusAreas")
  focusAreas                  FocusAreaHierarchy[]          @relation("focusAreas")
  subFocusAreas               FocusAreaHierarchy[]          @relation("subfocusAreas")
  TeamFocusAreaVersionHistory TeamFocusAreaVersionHistory[]
}

model TeamFocusArea {
  id              Int       @id @default(autoincrement())
  teamUid         String
  team            Team      @relation(fields: [teamUid], references: [uid], onDelete: Cascade)
  focusAreaUid    String
  focusArea       FocusArea @relation("teamFocusAreas", fields: [focusAreaUid], references: [uid], onDelete: Cascade)
  ancestorAreaUid String
  ancestorArea    FocusArea @relation("teamAncestorFocusAreas", fields: [ancestorAreaUid], references: [uid], onDelete: Cascade)

  @@unique([focusAreaUid, teamUid, ancestorAreaUid])
}

model ProjectFocusArea {
  id              Int       @id @default(autoincrement())
  projectUid      String
  project         Project   @relation(fields: [projectUid], references: [uid], onDelete: Cascade)
  focusAreaUid    String
  focusArea       FocusArea @relation("projectFocusAreas", fields: [focusAreaUid], references: [uid], onDelete: Cascade)
  ancestorAreaUid String
  ancestorArea    FocusArea @relation("projectAncestorFocusAreas", fields: [ancestorAreaUid], references: [uid], onDelete: Cascade)

  @@unique([focusAreaUid, projectUid, ancestorAreaUid])
}

model FocusAreaHierarchy {
  id              Int       @id @default(autoincrement())
  isDirect        Boolean
  focusAreaUid    String
  focusArea       FocusArea @relation("focusAreas", fields: [focusAreaUid], references: [uid], onDelete: Cascade)
  subFocusAreaUid String
  subFocusArea    FocusArea @relation("subfocusAreas", fields: [subFocusAreaUid], references: [uid], onDelete: Cascade)
}

model TeamFocusAreaVersionHistory {
  id             Int        @id @default(autoincrement())
  uid            String     @unique @default(cuid())
  teamUid        String
  team           Team       @relation(fields: [teamUid], references: [uid])
  teamName       String
  focusAreaUid   String?
  focusArea      FocusArea? @relation(fields: [focusAreaUid], references: [uid])
  focusAreaTitle String?
  modifiedBy     String
  user           Member     @relation(fields: [modifiedBy], references: [uid])
  username       String
  version        Int
  createdAt      DateTime   @default(now())
  modifiedAt     DateTime   @updatedAt

  @@unique([focusAreaUid, teamUid, version])
}

model MemberInteraction {
  id                   Int                           @id @default(autoincrement())
  uid                  String                        @unique @default(cuid())
  type                 String
  data                 Json?
  hasFollowUp          Boolean                       @default(false)
  sourceMemberUid      String
  sourceMember         Member                        @relation("SourceMemberInteractions", fields: [sourceMemberUid], references: [uid])
  targetMemberUid      String?
  targetMember         Member?                       @relation("TargetMemberInteractions", fields: [targetMemberUid], references: [uid])
  createdAt            DateTime                      @default(now())
  updatedAt            DateTime                      @updatedAt
  adjustments          MemberInteractionAdjustment[] @relation("InteractionAdjustments")
  interactionFollowUps MemberFollowUp[]

  @@index([targetMemberUid, type], name: "MemberInteraction_target_type_idx")
}

model MemberFollowUp {
  id             Int                  @id @default(autoincrement())
  uid            String               @unique @default(cuid())
  status         MemberFollowUpStatus
  type           String
  data           Json?
  isDelayed      Boolean              @default(false)
  interactionUid String?
  interaction    MemberInteraction?   @relation(fields: [interactionUid], references: [uid])
  createdBy      String
  creator        Member               @relation(fields: [createdBy], references: [uid])
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  feedbacks      MemberFeedback?
}

model MemberFeedback {
  id          Int                        @id @default(autoincrement())
  uid         String                     @unique @default(cuid())
  type        String
  data        Json?
  rating      Int?
  comments    String[]
  response    MemberFeedbackResponseType
  followUpUid String                     @unique
  followUp    MemberFollowUp             @relation(fields: [followUpUid], references: [uid])
  createdBy   String
  creator     Member                     @relation(fields: [createdBy], references: [uid])
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
}

model DiscoveryQuestion {
  id               Int                    @id @default(autoincrement())
  uid              String                 @unique @default(cuid())
  title            String?
  content          String
  viewCount        Int?
  shareCount       Int?
  slug             String                 @unique
  isActive         Boolean                @default(true)
  teamUid          String?
  team             Team?                  @relation("TeamRelatedDiscoveryQuestions", fields: [teamUid], references: [uid])
  teamName         String?
  projectUid       String?
  project          Project?               @relation("ProjectRelatedDiscoveryQuestions", fields: [projectUid], references: [uid])
  projectName      String?
  eventUid         String?
  plevent          PLEvent?               @relation("PLEventRelatedDiscoveryQuestions", fields: [eventUid], references: [uid])
  eventName        String?
  createdBy        String
  creator          Member?                @relation("MemberCreatedDiscoveryQuestions", fields: [createdBy], references: [uid])
  modifiedBy       String
  modifier         Member?                @relation("MemberModifiedDiscoveryQuestions", fields: [modifiedBy], references: [uid])
  answer           String?
  answerSources    Json[]
  answerSourceFrom String?
  relatedQuestions Json[]
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  type             DiscoveryQuestionType?
}

model MemberSubscription {
  id           Int                    @id @default(autoincrement())
  uid          String                 @unique @default(uuid())
  memberUid    String
  entityUid    String
  entityAction String
  entityType   SubscriptionEntityType
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  member       Member                 @relation(fields: [memberUid], references: [uid])
  isActive     Boolean                @default(true)

  @@index([memberUid, entityUid, entityType])
}

model Notification {
  id             Int                @id @default(autoincrement())
  uid            String             @unique @default(uuid())
  entityUid      String
  entityAction   String
  entityType     String
  status         NotificationStatus
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  additionalInfo Json?
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum SubscriptionEntityType {
  EVENT_LOCATION
}

model MemberExperience {
  id               Int       @id @default(autoincrement())
  uid              String    @unique @default(uuid())
  title            String
  company          String
  location         String?
  description      String?
  startDate        DateTime
  endDate          DateTime?
  isCurrent        Boolean   @default(false)
  isFlaggedByUser  Boolean   @default(false)
  isModifiedByUser Boolean   @default(false)
  userUpdatedAt    DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  memberUid        String
  member           Member    @relation(fields: [memberUid], references: [uid])
}

enum RecommendationRunStatus {
  OPEN
  CLOSED
  SENT
}

model RecommendationRun {
  id                 Int                          @id @default(autoincrement())
  uid                String                       @unique @default(cuid())
  targetMember       Member                       @relation(fields: [targetMemberUid], references: [uid])
  targetMemberUid    String
  status             RecommendationRunStatus      @default(OPEN)
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt
  recommendations    Recommendation[]
  emailNotifications RecommendationNotification[]
}

model Recommendation {
  id                   Int                          @id @default(autoincrement())
  uid                  String                       @unique @default(cuid())
  recommendationRun    RecommendationRun            @relation(fields: [recommendationRunUid], references: [uid])
  recommendationRunUid String
  recommendedMember    Member                       @relation(fields: [recommendedMemberUid], references: [uid])
  recommendedMemberUid String
  score                Float
  factors              Json // Stores the factors that influenced this recommendation
  status               ApprovalStatus               @default(PENDING)
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt
  emailNotifications   RecommendationNotification[] @relation("NotificationRecommendations")
}

model RecommendationNotification {
  id                   Int               @id @default(autoincrement())
  uid                  String            @unique @default(cuid())
  recommendationRun    RecommendationRun @relation(fields: [recommendationRunUid], references: [uid])
  recommendationRunUid String
  targetMember         Member            @relation(fields: [targetMemberUid], references: [uid])
  targetMemberUid      String
  email                String
  subject              String
  isExample            Boolean           @default(false)
  recommendations      Recommendation[]  @relation("NotificationRecommendations")
  sentAt               DateTime          @default(now())
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
}

model NotificationSetting {
  id                     Int       @id @default(autoincrement())
  memberUid              String    @unique
  member                 Member    @relation(fields: [memberUid], references: [uid], onDelete: Cascade)
  recommendationsEnabled Boolean   @default(false)
  subscribed             Boolean   @default(false)
  exampleSent            Boolean   @default(false)
  exampleAttempts        Int       @default(0)
  lastExampleSentAt      DateTime?
  onboardingAttempts     Int       @default(0)
  lastOnboardingSentAt   DateTime?
  showInvitationDialog   Boolean   @default(true)
  emailFrequency         Int       @default(14)
  byFocusArea            Boolean   @default(true)
  byRole                 Boolean   @default(true)
  byFundingStage         Boolean   @default(true)
  byIndustryTag          Boolean   @default(true)
  byTechnology           Boolean   @default(true)
  byKeyword              Boolean   @default(true)
  focusAreaList          String[]  @default([])
  roleList               String[]  @default([])
  fundingStageList       String[]  @default([])
  industryTagList        String[]  @default([])
  technologyList         String[]  @default([])
  keywordList            String[]  @default([])
}

model LinkedInProfile {
  id                Int       @id @default(autoincrement())
  uid               String    @unique @default(cuid())
  memberUid         String    @unique
  member            Member    @relation(fields: [memberUid], references: [uid], onDelete: Cascade)
  linkedinProfileId String    @unique
  linkedinHandler   String?
  profileData       Json
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

enum CounterAdjustmentReason {
  NEGATIVE_FEEDBACK
  CANCELLED
  RESCHEDULED
}

model MemberInteractionAdjustment {
  id             Int                     @id @default(autoincrement())
  uid            String                  @unique
  interactionUid String
  reason         CounterAdjustmentReason
  createdBy      String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @default(now())

  // Named relations pointing to back fields on MemberInteraction and Member
  interaction   MemberInteraction @relation("InteractionAdjustments", fields: [interactionUid], references: [uid], onDelete: Cascade, onUpdate: Cascade)
  createdByUser Member?           @relation("AdjustmentCreatedBy", fields: [createdBy], references: [uid], onDelete: SetNull, onUpdate: Cascade)

  @@unique([interactionUid, reason], name: "MemberInteractionAdjustment_interaction_reason_unique")
}

enum TeamFundraisingProfileStatus {
  DISABLED
  DRAFT
  PUBLISHED
}

model TeamFundraisingProfile {
  id  Int    @id @default(autoincrement())
  uid String @unique @default(cuid())

  teamUid String
  team    Team   @relation(fields: [teamUid], references: [uid], onDelete: Cascade)

  demoDayUid String
  demoDay    DemoDay @relation(fields: [demoDayUid], references: [uid], onDelete: Cascade)

  onePagerUploadUid String?
  onePagerUpload    Upload? @relation("TFP_onePagerUpload", fields: [onePagerUploadUid], references: [uid])

  videoUploadUid String?
  videoUpload    Upload? @relation("TFP_videoUpload", fields: [videoUploadUid], references: [uid])

  description String?

  status TeamFundraisingProfileStatus @default(DRAFT)

  createdAt                 DateTime                          @default(now())
  updatedAt                 DateTime                          @updatedAt
  lastModifiedBy            String?
  lastModifier              Member?                           @relation("TfpLastModifiedBy", fields: [lastModifiedBy], references: [uid])
  expressInterestStatistics DemoDayExpressInterestStatistic[]

  @@unique([teamUid, demoDayUid])
  @@index([status])
}

enum UploadStorage {
  IPFS
  S3
}

enum UploadKind {
  IMAGE
  SLIDE
  VIDEO
  OTHER
}

enum UploadScopeType {
  NONE
  TEAM
  MEMBER
  PROJECT
}

enum UploadStatus {
  UPLOADED
  PROCESSING
  READY
  FAILED
}

model Upload {
  id      Int           @id @default(autoincrement())
  uid     String        @unique @default(cuid())
  storage UploadStorage
  kind    UploadKind
  status  UploadStatus  @default(READY)

  scopeType UploadScopeType @default(NONE)
  scopeUid  String?

  uploaderUid String?
  uploader    Member? @relation("MemberUploads", fields: [uploaderUid], references: [uid])

  bucket               String?
  key                  String?
  cid                  String?
  url                  String
  filename             String
  mimetype             String
  size                 Int
  checksum             String?
  meta                 Json?
  previewImageUrl      String?
  previewImageSmallUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teamFundraisingProfilesAsOnePager TeamFundraisingProfile[] @relation("TFP_onePagerUpload")
  teamFundraisingProfilesAsVideo    TeamFundraisingProfile[] @relation("TFP_videoUpload")

  @@index([scopeType, scopeUid])
  @@index([kind])
  @@index([uploaderUid])
}

enum InvestorProfileType {
  ANGEL
  FUND
  ANGEL_AND_FUND
}

model InvestorProfile {
  id                    Int                  @id @default(autoincrement())
  uid                   String               @unique @default(cuid())
  secRulesAccepted      Boolean              @default(false)
  secRulesAcceptedAt    DateTime?
  investmentFocus       String[]
  investInStartupStages String[]             @default([])
  investInFundTypes     String[]             @default([])
  typicalCheckSize      Float?
  isInvestViaFund       Boolean?
  type                  InvestorProfileType?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  teamUid               String?
  team                  Team?                @relation("TeamInvestorProfile")
  memberUid             String?
  member                Member?              @relation("MemberInvestorProfile")

  @@unique([teamUid])
  @@unique([memberUid])
}

enum DemoDayAdminScopeType {
  HOST                  // host-based permissions (e.g. "plnetwork.io")
  DASHBOARD_WHITELIST   // dashboard access whitelist (scopeValue = '*' for all)
}

enum DemoDayStatus {
  UPCOMING
  REGISTRATION_OPEN
  EARLY_ACCESS
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum DemoDayParticipantType {
  INVESTOR
  FOUNDER
  SUPPORT
}

enum DemoDayParticipantStatus {
  PENDING
  INVITED
  ENABLED
  DISABLED
}

model DemoDay {
  id                        Int                               @id @default(autoincrement())
  uid                       String                            @unique @default(cuid())
  slugURL                   String                            @unique
  host                      String                            @default("plnetwork.io")
  startDate                 DateTime
  endDate                   DateTime
  approximateStartDate      String?
  title                     String
  description               String
  shortDescription          String?
  supportEmail              String?
  status                    DemoDayStatus                     @default(UPCOMING)
  notificationsEnabled      Boolean                           @default(false)
  dashboardEnabled          Boolean                           @default(false)
  notifyBeforeStartHours    Int?                              @default(336)
  notifyBeforeEndHours      Int?                              @default(48)
  createdAt                 DateTime                          @default(now())
  updatedAt                 DateTime                          @updatedAt
  isDeleted                 Boolean                           @default(false)
  deletedAt                 DateTime?
  participants              DemoDayParticipant[]
  fundraisingProfiles       TeamFundraisingProfile[]
  engagements               DemoDayEngagement[]
  expressInterestStatistics DemoDayExpressInterestStatistic[]
  feedbacks                 DemoDayFeedback[]
}

model MemberDemoDayAdminScope {
  id         Int                   @id @default(autoincrement())
  memberUid  String
  scopeType  DemoDayAdminScopeType
  scopeValue String // e.g. "plnetwork.io" when scopeType = HOST
  config     Json? // optional extra config for this scope

  member Member @relation(fields: [memberUid], references: [uid], onDelete: Cascade)

  @@unique([memberUid, scopeType, scopeValue])
}

model DemoDayParticipant {
  id                      Int                      @id @default(autoincrement())
  uid                     String                   @unique @default(cuid())
  demoDayUid              String
  demoDay                 DemoDay                  @relation(fields: [demoDayUid], references: [uid], onDelete: Cascade)
  memberUid               String
  member                  Member                   @relation(fields: [memberUid], references: [uid], onDelete: Cascade)
  type                    DemoDayParticipantType
  status                  DemoDayParticipantStatus @default(INVITED)
  isDemoDayAdmin          Boolean                  @default(false)
  hasEarlyAccess          Boolean                  @default(false)
  confidentialityAccepted Boolean                  @default(false)
  teamUid                 String?
  team                    Team?                    @relation(fields: [teamUid], references: [uid])
  statusUpdatedAt         DateTime                 @default(now())
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  isDeleted               Boolean                  @default(false)
  deletedAt               DateTime?

  @@unique([demoDayUid, memberUid])
}

model Event {
  id          String   @id @default(cuid())
  eventId     String?  @unique
  eventType   String
  userId      String?
  userEmail   String?
  anonymousId String?
  sessionId   String?
  source      String?
  path        String?
  referrer    String?
  userAgent   String?
  requestIp   String?
  ts          DateTime
  receivedAt  DateTime @default(now())
  props       Json?

  @@unique([eventId, userId])
  @@index([eventType, ts])
  @@index([userId, ts])
  @@index([anonymousId, ts])
  @@index([sessionId, ts])
  @@index([ts])
}

model DemoDayEngagement {
  id  Int    @id @default(autoincrement())
  uid String @unique @default(cuid())

  demoDayUid String
  demoDay    DemoDay @relation(fields: [demoDayUid], references: [uid], onDelete: Cascade)

  memberUid String
  member    Member @relation(fields: [memberUid], references: [uid], onDelete: Cascade)

  calendarAddedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([demoDayUid, memberUid])
}

model DemoDayExpressInterestStatistic {
  id                        Int                    @id @default(autoincrement())
  uid                       String                 @unique @default(cuid())
  demoDayUid                String
  demoDay                   DemoDay                @relation(fields: [demoDayUid], references: [uid], onDelete: Cascade)
  memberUid                 String
  member                    Member                 @relation(fields: [memberUid], references: [uid], onDelete: Cascade)
  teamFundraisingProfileUid String
  teamFundraisingProfile    TeamFundraisingProfile @relation(fields: [teamFundraisingProfileUid], references: [uid], onDelete: Cascade)
  isPrepDemoDay             Boolean                @default(false)

  liked     Boolean @default(false)
  connected Boolean @default(false)
  invested  Boolean @default(false)
  referral  Boolean @default(false)
  feedback  Boolean @default(false)

  likedCount     Int @default(0)
  connectedCount Int @default(0)
  investedCount  Int @default(0)
  referralCount  Int @default(0)
  feedbackCount  Int @default(0)
  totalCount     Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([demoDayUid, memberUid, teamFundraisingProfileUid, isPrepDemoDay])
  @@index([memberUid, teamFundraisingProfileUid])
  @@index([demoDayUid])
  @@index([demoDayUid, teamFundraisingProfileUid], map: "DemoDayExpressInterestStatistic_demoDay_tfp_idx")
}

model DemoDayFeedback {
  id                  Int      @id @default(autoincrement())
  uid                 String   @unique @default(cuid())
  demoDayUid          String
  demoDay             DemoDay  @relation(fields: [demoDayUid], references: [uid], onDelete: Cascade)
  memberUid           String
  member              Member   @relation(fields: [memberUid], references: [uid], onDelete: Cascade)
  rating              Int // 1-5 scale (1 = Not Valuable, 5 = Extremely Valuable)
  qualityComments     String? // Optional feedback text
  improvementComments String? // Optional feedback text
  comment             String? // Optional feedback text
  issues              String[] // Array of issue types: predefined ("TECHNICAL_ISSUES", "ACCESS_ISSUES", "NETWORKING_ISSUES") or custom text
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([demoDayUid])
  @@index([memberUid, demoDayUid])
}

model ContactSupportRequest {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  topic     String
  email     String?
  name      String?
  message   String?
  metadata  Json?
  createdAt DateTime @default(now())
}

// Push Notification Categories - for real-time WebSocket notifications
enum PushNotificationCategory {
  // Demo Day engagement
  DEMO_DAY_LIKE
  DEMO_DAY_CONNECT
  DEMO_DAY_INVEST
  DEMO_DAY_REFERRAL
  DEMO_DAY_FEEDBACK
  // Demo Day announcements (status changes, etc.)
  DEMO_DAY_ANNOUNCEMENT
  // Forum
  FORUM_POST
  FORUM_REPLY
  // Events
  EVENT
  // System
  SYSTEM

  IRL_GATHERING
}

// Push notifications for WebSocket delivery
model PushNotification {
  id           Int                      @id @default(autoincrement())
  uid          String                   @unique @default(cuid())
  category     PushNotificationCategory
  title        String
  description  String?
  image        String? // URL to image
  link         String? // URL or route to navigate to
  metadata     Json?                    @default("{}")
  isPublic     Boolean                  @default(false) // If true, anyone can see; if false, only recipient
  recipientUid String? // Optional: Member.externalId of user to notify (null = broadcast/public)
  recipient    Member?                  @relation("PushNotificationRecipient", fields: [recipientUid], references: [externalId], onDelete: Cascade)
  accessLevels String[]                 @default([]) // Optional: list of access levels (L2, L3, L4, L5, L6) to target
  isRead       Boolean                  @default(false) // For private notifications only
  isSent       Boolean                  @default(false) // Whether sent via WebSocket
  sentAt       DateTime? // When sent via WebSocket
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  // Read status for public notifications (tracked per user)
  readStatuses PushNotificationReadStatus[]

  // Indexes based on actual query patterns:
  // - Public notifications: WHERE isPublic = true
  // - Private notifications: WHERE recipientUid = ? AND isPublic = false AND isRead = ?
  // - Access level notifications: WHERE array_length(accessLevels, 1) > 0
  @@index([isPublic])
  @@index([recipientUid, isPublic, isRead])
  @@index([link])
}

// Tracks read status per user for public notifications
model PushNotificationReadStatus {
  id             Int              @id @default(autoincrement())
  notificationId Int
  notification   PushNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  memberUid      String
  member         Member           @relation("PushNotificationReadStatuses", fields: [memberUid], references: [externalId], onDelete: Cascade)
  readAt         DateTime         @default(now())

  @@unique([notificationId, memberUid])
  @@index([memberUid])
  @@index([notificationId])
}

enum IrlGatheringPushRuleKind {
  UPCOMING
  REMINDER
}

model IrlGatheringPushCandidate {
  id             Int                      @id @default(autoincrement())
  uid            String                   @unique @default(cuid())
  ruleKind       IrlGatheringPushRuleKind
  gatheringUid   String
  eventUid       String
  eventStartDate DateTime
  eventEndDate   DateTime
  attendeeCount  Int
  isSuppressed   Boolean                  @default(false)
  processedAt    DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  @@unique([ruleKind, eventUid])
  @@index([ruleKind, gatheringUid])
  @@index([ruleKind, processedAt])
  @@index([eventStartDate])
  @@index([eventEndDate])
}

model IrlGatheringPushConfig {
  id  Int    @id @default(autoincrement())
  uid String @unique @default(cuid())

  /// Only one config row should be active at a time.
  isActive Boolean @default(true)

  /// Global switch for IRL gathering push logic.
  enabled Boolean @default(true)

  /// Base threshold: minimum number of attendees required for an event
  /// to become a push candidate.
  minAttendeesPerEvent Int @default(5)

  /// Group-level gate: total number of events in the upcoming window
  /// required before we send any push for a gathering.
  totalEventsThreshold Int @default(5)

  /// Group-level gate: minimum number of events that qualify by attendee + time
  /// filters (upcoming/reminder candidates) before we send any push for a gathering.
  qualifiedEventsThreshold Int @default(2)

  /// Upcoming window: consider event a candidate only if
  /// startDate <= now + upcomingWindowDays.
  upcomingWindowDays Int @default(7)

  /// Reminder: how many days before the event start date the reminder
  /// should be eligible (job decides exact sending date/time).
  reminderDaysBefore Int @default(1)

  /// Audit info (optional).
  updatedByMemberUid String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([enabled])
  @@index([updatedAt])
}
