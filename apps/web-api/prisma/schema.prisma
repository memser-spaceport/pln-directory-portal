// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["interactiveTransactions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// TODO: User accounts mapped from Clerk
/// TODO: User permissions/grants

model Team {
  id                Int                @id @default(autoincrement())
  uid               String             @unique @default(cuid())
  name              String             @unique
  logo              Image?             @relation(fields: [logoUid], references: [uid])
  logoUid           String?
  blog              String?
  officeHours       String?
  website           String?
  contactMethod     String?
  twitterHandler    String?
  linkedinHandler   String?
  telegramHandler   String?
  shortDescription  String?
  longDescription   String?
  plnFriend         Boolean            @default(false)
  airtableRecId     String?            @unique
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  teamMemberRoles   TeamMemberRole[]
  industryTags      IndustryTag[]
  membershipSources MembershipSource[]
  fundingStage      FundingStage?      @relation(fields: [fundingStageUid], references: [uid])
  fundingStageUid   String?
  technologies      Technology[]
  moreDetails       String?
  Project           Project[]
}

model Member {
  id              Int              @id @default(autoincrement())
  uid             String           @unique @default(cuid())
  name            String
  email           String?          @unique
  image           Image?           @relation(fields: [imageUid], references: [uid])
  imageUid        String?
  githubHandler   String?
  discordHandler  String?
  twitterHandler  String?
  linkedinHandler String?
  telegramHandler String?
  officeHours     String?
  moreDetails     String?
  plnFriend       Boolean          @default(false)
  plnStartDate    DateTime?
  airtableRecId   String?          @unique
  externalId      String?          @unique
  openToWork      Boolean?         @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  skills          Skill[]
  location        Location?        @relation(fields: [locationUid], references: [uid])
  locationUid     String?
  teamMemberRoles TeamMemberRole[]
  memberRoles     MemberRole[]
  preferences     Json?
  experience      Experience[]
  Project         Project[]
}

model MemberRole {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  members   Member[]
}

enum ParticipantType {
  MEMBER
  TEAM
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  AUTOAPPROVED
}

model ParticipantsRequest {
  id               Int             @id @default(autoincrement())
  uid              String          @unique @default(cuid())
  participantType  ParticipantType
  status           ApprovalStatus  @default(PENDING)
  oldData          Json?
  newData          Json
  referenceUid     String?
  requesterEmailId String
  uniqueIdentifier String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
}

model Skill {
  id          Int      @id @default(autoincrement())
  uid         String   @unique @default(cuid())
  title       String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  members     Member[]
}

model Location {
  id                 Int      @id @default(autoincrement())
  uid                String   @unique @default(cuid())
  // On the location-transfer.service.ts we are adding the metroArea to the placeId to avoid duplicates because
  // since the metroArea is not valid on the Google Places API we need to append this field to avoid rewriting the same location
  placeId            String   @unique
  city               String?
  country            String
  continent          String
  region             String?
  regionAbbreviation String?
  metroArea          String?
  latitude           Float
  longitude          Float
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  members            Member[]

  @@unique([continent, country, region, city, metroArea, latitude, longitude])
}

model TeamMemberRole {
  id        Int       @id @default(autoincrement())
  mainTeam  Boolean   @default(false)
  teamLead  Boolean   @default(false)
  startDate DateTime?
  endDate   DateTime?
  role      String?
  member    Member    @relation(fields: [memberUid], references: [uid], onDelete: Cascade)
  memberUid String
  team      Team      @relation(fields: [teamUid], references: [uid], onDelete: Cascade)
  teamUid   String

  // One member can only have one role per team
  @@unique([memberUid, teamUid])
}

model IndustryCategory {
  id           Int           @id @default(autoincrement())
  uid          String        @unique @default(cuid())
  title        String        @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  industryTags IndustryTag[]
}

model IndustryTag {
  id                  Int               @id @default(autoincrement())
  uid                 String            @unique @default(cuid())
  title               String            @unique
  definition          String?
  airtableRecId       String?           @unique
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  industryCategory    IndustryCategory? @relation(fields: [industryCategoryUid], references: [uid])
  industryCategoryUid String?
  teams               Team[]
}

model FundingStage {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teams     Team[]
}

model MembershipSource {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teams     Team[]
}

model Technology {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teams     Team[]
}

model Image {
  id             Int          @id @default(autoincrement())
  uid            String       @unique @default(cuid())
  // The cid is not unique because this id represents an array of multiple images
  // with different sizes that can be accessed trough the cid and filename
  cid            String
  width          Int
  height         Int
  url            String
  filename       String
  size           Int
  type           String
  version        ImageSize
  // This image can be a thumbnail to other image
  thumbnailToUid String?
  thumbnailTo    Image?       @relation("ImageThumbnails", fields: [thumbnailToUid], references: [uid])
  // This image can have multiple thumbnails
  thumbnails     Image[]      @relation("ImageThumbnails")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  // Reverse Relations:
  Team           Team[]
  Member         Member[]
  Project        Project[]
  Experience     Experience[]
}

model Experience {
  id          Int      @id @default(autoincrement())
  uid         String   @unique @default(cuid())
  companyName String
  logoUid     String?
  companylogo Image?   @relation(fields: [logoUid], references: [uid])
  title       String
  currentTeam Boolean  @default(false)
  startDate   DateTime
  endDate     DateTime
  description String?
  memberUid   String
  member      Member?  @relation(fields: [memberUid], references: [uid])
}

model Faq {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(cuid())
  email     String   @db.VarChar(100)
  question  String
  requestIp String   @db.VarChar(35)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id                Int           @id @default(autoincrement())
  uid               String        @unique @default(cuid())
  logo              Image?        @relation(fields: [logoUid], references: [uid])
  logoUid           String?
  name              String
  tagline           String
  description       String
  contactEmail      String
  lookingForFunding Boolean       @default(false)
  projectLinks      Json?
  kpis              Json?
  readMe            String?
  creator           Member?       @relation(fields: [createdBy], references: [uid])
  createdBy         String
  team              Team?         @relation(fields: [teamUid], references: [uid])
  teamUid           String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

enum ImageSize {
  ORIGINAL
  LARGE
  MEDIUM
  SMALL
  TINY
}
